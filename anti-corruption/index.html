<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script>
      
    	document.getElementsByTagName('html')[0].style.fontSize = document.documentElement.clientWidth / 10+'px';
    </script>
    <title>反腐</title>
    <style>
      *{margin:0;padding:0;}
    </style>
  </head>
  <body>
    <div id="app"></div>
    <div id="zmiti-stage">
      
    </div>
    <script src='https://www.phaser-china.com/examples/libs/phaser.min.js'></script>
    <!-- built files will be auto injected -->
    <script>
       window.onload = function(){
          var viewW = document.documentElement.clientWidth,
              viewH = document.documentElement.clientHeight;

          var game = new Phaser.Game(viewW,viewH,Phaser.CANVAS,'zmiti-stage',state);

          function state(){
              this.init = function(){
                //game.stage.setBackgroundColor(0xff0000);
              }
              this.preload = function(){
                game.load.image('jump','./src/assets/images/jump.png');
                game.load.image('bg','./src/assets/images/bg.jpg');
                game.load.spritesheet('person','./src/assets/images/person.png',177,112);

                game.load.image('energy','./src/assets/images/energy.png');

                game.load.spritesheet('tigger','./src/assets/images/tigger.png',135,200)
                
                game.load.spritesheet('fly','./src/assets/images/fly.png',81,82)

                
                game.load.onFileComplete.add(function(){
                  //console.log(game.load.progress);
                });

              }
              var s = this;

              var sprite,
                  animation,
                  bg,
                  energy,
                  jumper,
                  tiggerSprite,
                  tiggerAnimation,
                  flySprite,
                  flyAnimaiton;
              this.create  = function(){
                //game.world.setBounds(0,0,viewW,2004*viewW/750);
                bg = game.add.tileSprite(0,0,game.width*2,game.height*2,'bg');
               // bg.autoScroll(0,-140);
                
                ///game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
                bg.scale.set(.6,.6)
                ///console.log(bg,game.height);

                //行走的人物
                sprite = game.add.sprite(62,100,'person');
                sprite.scale.set(.5,.5)
                animation = sprite.animations.add('run',[0,1,2]);
                sprite.animations.play('run',5,true);


                //行走的老虎
                tiggerSprite = game.add.sprite(62,400,'tigger');
                tiggerAnimation =tiggerSprite.animations.add('tiggerrun',[0,1,2]);
                tiggerSprite.scale.set(.4,.4)
                tiggerSprite.animations.play('tiggerrun',5,true);

                //飞行的苍蝇
                flySprite = game.add.sprite(140,400,'fly');
                flyAnimaiton = flySprite.animations.add('flyfly',[0,1,2,3,4,5,6,7,8]);
                flySprite.scale.set(.5,.5);
                flySprite.animations.play('flyfly',15,true);


                jumper = game.add.sprite(62,100,'jump')
                jumper.scale.set(.5,.5);
                jumper.exists = false;

 
                energy = game.add.sprite(viewW/2,game.height,'energy');

              

               /* var tween = game.add.tween(jumper);
                tween.to({x:120},700,Phaser.Easing.Power1,false,0,0,true);*/

                var isMove = false;

                game.input.onTap.add(function(){
                  if(isMove || jumper.isDown) return;
                  jumper.isDown = true;
                  sprite.exists = false;
                  jumper.exists = true;

                  /*tween.start();
                  tween.onComplete.add(function(){
                    sprite.exists = true;
                    jumper.exists = false;                    
                  })*/

                    
                  s.speed = 100;
                  jumper.body.velocity = new Phaser.Point(80,0);

                  jumper.body.acceleration = new Phaser.Point(-80,0)
                  
                });

         

                var touch = new Phaser.Touch(game);

                touch.onTouchStart = function(e){
                  e.preventDefault()
                  this.startY = e.changedTouches[0].pageY;
                  this.startTime = new Date().getTime();
                };

                touch.onTouchMove = function(e){
                  e.preventDefault()
                  isMove = true;//禁用点击事件tap
                };



                //开启物理引擎
                game.physics.startSystem(Phaser.Physics.ARCADE);


                game.physics.enable(energy,Phaser.Physics.ARCADE);
                game.physics.enable(sprite,Phaser.Physics.ARCADE);


                game.physics.enable(jumper,Phaser.Physics.ARCADE);
                game.physics.enable(tiggerSprite,Phaser.Physics.ARCADE);


                energy.body.velocity = new Phaser.Point(0,-30)

                energy.body.acceleration = new Phaser.Point(0,-10)


                tiggerSprite.body.velocity = new Phaser.Point(0,-30)

                tiggerSprite.body.acceleration = new Phaser.Point(0,-10)



                this.speed = 0;
                
                touch.onTouchEnd= function(e){
                  isMove = false;
                  this.endY = e.changedTouches[0].pageY;
                  var disY = Math.abs(this.startY-this.endY);
                  this.endTime = new Date().getTime();
                  if(disY>50){
                    var disTime = this.endTime - this.startTime;
                    s.speed +=20;
                    if(s.speed>=102){
                      s.speed = 101;
                    }


                  }

                };
                touch.start();
               
              } 
              this.update = function(){
                
                this.speed -= 1;

                if(this.speed<=0){
                  this.speed = 0;
                  ///animation = sprite.animations.add('run',[1]);
                }else{
                  //animation = sprite.animations.add('run',[0,1,2]);
                }

                bg.autoScroll(0,!this.speed?0:(this.speed*3 + 200)*-1);

                if(jumper.x<62){
                  jumper.x = 62;
                  jumper.body.velocity = new Phaser.Point(0,0)
                  sprite.exists = true;
                  jumper.exists = false;
                  jumper.isDown = false;  
                }
        
                console.log(this.speed)
                animation.speed = this.speed / 5<5?5:this.speed / 5;
                animation.speed =  animation.speed > 25 ? 25 : animation.speed;
                ///document.title = this.speed;
               



                game.physics.arcade.overlap(jumper,energy,function(){
                  energy.exists = false;
                })


                game.physics.arcade.overlap(sprite,tiggerSprite,function(){
                  console.log(tiggerSprite.x,tiggerSprite.y)
                  tiggerSprite.exists = false;

                })


               
              }           
          }
          game.state.add( 'state',state);

          game.state.start('state');

       }
    </script>
  </body>
</html>
